<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>Day 5 - hyper | 24daysofrust</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.0.1">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="../book/day6.html" />
    
    
    <link rel="prev" href="../book/day4.html" />
    

        
    </head>
    <body>
        
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
    

        
    <div class="book" data-level="5" data-basepath=".." data-revision="Sat May 16 2015 17:24:30 GMT+0000 (UTC)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        

        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="book/day1.html">
            
                
                    <a href="../book/day1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Day 1 - Cargo and crates.io
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="book/day2.html">
            
                
                    <a href="../book/day2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Day 2 - slow_primes
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="book/day3.html">
            
                
                    <a href="../book/day3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Day 3 - csv
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="book/day4.html">
            
                
                    <a href="../book/day4.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Day 4 - docopt
                    </a>
                
            
            
        </li>
    
        <li class="chapter active" data-level="5" data-path="book/day5.html">
            
                
                    <a href="../book/day5.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Day 5 - hyper
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="book/day6.html">
            
                
                    <a href="../book/day6.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Day 6 - working with JSON
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="book/day7.html">
            
                
                    <a href="../book/day7.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Day 7 - itertools
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="book/day8.html">
            
                
                    <a href="../book/day8.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Day 8 - racer
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="book/day9.html">
            
                
                    <a href="../book/day9.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        Day 9 - anymap
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="book/day10.html">
            
                
                    <a href="../book/day10.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        Day 10 - the glorious tau
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="book/day11.html">
            
                
                    <a href="../book/day11.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        Day 11 - postgres
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="book/day12.html">
            
                
                    <a href="../book/day12.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        Day 12 - image
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="book/day13.html">
            
                
                    <a href="../book/day13.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        Day 13 - uuid
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="book/day14.html">
            
                
                    <a href="../book/day14.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        Day 14 - nalgebra
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="book/day15.html">
            
                
                    <a href="../book/day15.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        Day 15 - FUSE filesystems, part 1
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="book/day16.html">
            
                
                    <a href="../book/day16.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        Day 16 - FUSE filesystems, part 2
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="book/day17.html">
            
                
                    <a href="../book/day17.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        Day 17 - from_fn
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="book/day18.html">
            
                
                    <a href="../book/day18.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        Day 18 - redis
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="book/day19.html">
            
                
                    <a href="../book/day19.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        Day 19 - rusti
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="book/day20.html">
            
                
                    <a href="../book/day20.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        Day 20 - zeromq
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="book/day21.html">
            
                
                    <a href="../book/day21.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        Day 21 - rust-crypto
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="book/day22.html">
            
                
                    <a href="../book/day22.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        Day 22 - built with Rust
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="book/day23.html">
            
                
                    <a href="../book/day23.html">
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        Day 23 - calling Rust from other languages
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="book/day24.html">
            
                
                    <a href="../book/day24.html">
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                        Day 24 - conclusion
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                Published with GitBook
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >24daysofrust</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="day-5-hyper">Day 5 - hyper</h1>
<p>The state of HTTP libraries in Rust is a constant flux. See <a href="http://arewewebyet.com/" target="_blank">Are we web yet?</a> for an overview of the current affairs. There&apos;s <code>rust-http</code> which although usable (for example <a href="http://nickel.rs/" target="_blank">Nickel</a> builds on top of that) is not developed anymore. <a href="http://teepee.rs/" target="_blank">Teepee</a>, it&apos;s conceptual successor, is in the words of it&apos;s author <em>not even vaguely usable</em>. Meanwhile a new library emerged during the last few months: <a href="https://github.com/hyperium/hyper" target="_blank">hyper</a>, which will be the subject of this blogpost.</p>
<p>I&apos;m going to focus on using <code>hyper</code> only as a client, although the library contains also a server implementation. However with the advance of Rust web frameworks building on top of HTTP libraries, the programmers will focus less on developing servers and more on the clients. Consuming web APIs is a lot more common than writing new shiny servers. How can <code>hyper</code> help us?</p>
<h2 id="basic-requests">Basic requests</h2>
<p>Let&apos;s start from the usual dependency definition in <code>Cargo.toml</code>.</p>
<pre><code>:::rust
[dependencies.hyper]
git = &quot;https://github.com/hyperium/hyper&quot;
</code></pre><p>Note: at the time of writing this post the version hosted on crates.io does not compile with the latest nightly. That&apos;s why the dependency points to a git repository.</p>
<p>When you run <code>cargo build</code>, Cargo will download a few other required crates (for URL handling, mimetype support, OpenSSL bindings etc.) and hopefully compile <code>hyper</code> afterwards. Time for our first request!</p>
<pre><code>:::rust
extern crate hyper;

use hyper::Url;
use hyper::client::Request;

fn main() {
    let url = match Url::parse(&quot;http://httpbin.org/status/200&quot;) {
        Ok(url) =&gt; url,
        Err(_) =&gt; panic!(&quot;Uh oh.&quot;),
    };
    println!(&quot;&gt; get: {}&quot;, url);
    let fresh_request = match Request::get(url) {
        Ok(request) =&gt; request,
        Err(_) =&gt; panic!(&quot;Whoops.&quot;),
    };
    let streaming_request = match fresh_request.start() {
        Ok(request) =&gt; request,
        Err(_) =&gt; panic!(&quot;Noooo.&quot;),
    };
    let mut response = match streaming_request.send() {
        Ok(response) =&gt; response,
        Err(_) =&gt; panic!(&quot;So close...&quot;),
    };
    println!(&quot;&lt; status code: {}&quot;, response.status);
    let content = match response.read_to_string() {
        Ok(content) =&gt; content,
        Err(_) =&gt; panic!(&quot;I give up.&quot;),
    };
    println!(&quot;{}&quot;, content);
}
</code></pre><p>That was... <em>verbose</em>. I could just use <code>unwrap()</code> everywhere, but that would be handwaving and in poor taste. Sprinkling your code with <code>panic!</code> is not a sign of good style too. However, there are so many things that can go wrong during an HTTP request/response cycle! But there seems to be a pattern. Can we do better?</p>
<pre><code>:::rust
fn get_content(url: &amp;amp;str) -&gt; HttpResult&lt;String&gt; {
    let url = match Url::parse(url) {
        Ok(url) =&gt; url,
        Err(_) =&gt; return Err(HttpError::HttpUriError),
    };
    let fresh_request = try!(Request::get(url));
    let streaming_request = try!(fresh_request.start());
    let mut response = try!(streaming_request.send());
    Ok(try!(response.read_to_string()))
}

fn main() {
    println!(&quot;{}&quot;, get_content(&quot;http://httpbin.org/status/200&quot;));
}
</code></pre><p>We refactored the request cycle into a separate function. But look how the code got simpler, thanks to the <a href="http://doc.rust-lang.org/std/result/#the-try!-macro" target="_blank">try! macro</a>. There&apos;s no explicit matching on the <code>HttpResult</code> variants and the first <code>try!</code> that fails will return from the function with some kind of an HTTP error. Unfortunately we have to do it explicitly in case of <code>Url::parse()</code>. It would be possible to use <code>try!</code> there too if the following code compiled:</p>
<pre><code>:::rust
extern crate hyper;
extern crate url;

use std::error::FromError;
use hyper::HttpError;
use url::ParseError;

impl FromError&lt;ParseError&gt; for HttpError {
    fn from_error(err: ParseError) -&gt; HttpError {
        HttpError::HttpUriError
    }
}
</code></pre><p>This is the current mechanism for <a href="https://github.com/rust-lang/rfcs/blob/master/text/0201-error-chaining.md" target="_blank">interoperation between errors</a>.
Unfortunately we get scolded by the compiler saying <code>error: cannot provide an extension implementation where both trait and type are not defined in this crate</code>. But if that <code>impl</code> was bundled with hyper... <em>gently prodding the maintainers</em> :-)</p>
<h2 id="post-and-query-parameters">POST and query parameters</h2>
<p>Sending POST requests with hyper is only a little bit more complicated. We&apos;ll write a wrapper function again, this time taking an additional argument of type <code>Query</code>.</p>
<pre><code>:::rust
extern crate url;

use hyper::header::ContentLength;
use url::form_urlencoded;

type Query&lt;&apos;a&gt; = Vec&lt;(&amp;amp;&apos;a str, &amp;amp;&apos;a str)&gt;;

fn post_query(url: &amp;amp;str, query: Query) -&gt; HttpResult&lt;String&gt; {
    let url = match Url::parse(url) {
        Ok(url) =&gt; url,
        Err(_) =&gt; return Err(HttpError::HttpUriError),
    };
    let body = form_urlencoded::serialize(query.into_iter());
    let mut fresh_request = try!(Request::post(url));
    fresh_request.headers_mut().set(ContentLength(body.len()));
    let mut streaming_request = try!(fresh_request.start());
    try!(streaming_request.write_str(body[]));
    let mut response = try!(streaming_request.send());
    Ok(try!(response.read_to_string()))
}

let query = vec![(&quot;key&quot;, &quot;value&quot;), (&quot;foo&quot;, &quot;bar&quot;)];
println!(&quot;{}&quot;, post_query(&quot;http://httpbin.org/post&quot;, query));
</code></pre><p>The main differences from <code>get_content()</code> are more mutable variables and the serialization machinery. Once we&apos;ve built a raw request body (like <code>key=value&amp;amp;foo=bar</code>), we can take advantage of <code>Writer</code> implementation for <code>Request&lt;Streaming&gt;</code> and call <code>write_str()</code> with a slice of the raw body. We also have to set the <code>Content-Length</code> header, which is strongly typed in hyper.</p>
<h2 id="sending-json">Sending JSON</h2>
<p>Our <code>post_query</code> function can be easily changed to borrow a struct, serialize it to JSON and send it over the wire.</p>
<pre><code>:::rust
extern crate serialize;

use serialize::{Encodable, json};
use std::io::IoError;

fn post_json&lt;&apos;a, T&gt;(url: &amp;amp;str, payload: &amp;amp;T) -&gt; HttpResult&lt;String&gt;
        where T: Encodable&lt;json::Encoder&lt;&apos;a&gt;, IoError&gt; {
    let body = json::encode(payload);
    // rest of the code as before
}
</code></pre><p>This function is generic in its <code>payload</code> argument, accepting anything that implements the <code>Encodable</code> trait. We use a <code>where</code> clause to specify trait bounds which are slightly complex in this case. We can use the function as follows:</p>
<pre><code>:::rust
#[deriving(Encodable)]
struct Movie {
    title: String,
    bad_guy: String,
    pub_year: uint,
}

let movie = Movie {
    title: &quot;You Only Live Twice&quot;.to_string(),
    bad_guy: &quot;Blofeld&quot;.to_string(),
    pub_year: 1967,
};
println!(&quot;{}&quot;, post_json(&quot;http://httpbin.org/post&quot;, &amp;amp;movie));
</code></pre><h2 id="where-to-go-from-here">Where to go from here?</h2>
<p>As you may have noticed, hyper&apos;s HTTP client API is not as high-level as for example <a href="http://docs.python-requests.org/en/latest/" target="_blank">requests</a>. However the library is still under active development and the API may or may not change. Secondly, there are a few projects that aim to wrap hyper behind a simpler facade - I mention two of these at the end of this blog post. The future of HTTP in Rust will change for sure, but I&apos;m hopeful!</p>
<h2 id="see-also">See also</h2>
<ul>
<li><a href="https://github.com/servo/servo/wiki/HTTP-library-requirements" target="_blank">HTTP library requirements</a> from the Servo project</li>
<li><a href="https://github.com/jgillich/rust-request" target="_blank">rust-request</a> - a HTTP client library written on top of hyper</li>
<li><a href="https://github.com/gtolle/rest_client" target="_blank">rest_client</a> - another HTTP client built with hyper</li>
<li><a href="http://lucumr.pocoo.org/2014/11/6/error-handling-in-rust/" target="_blank">Improved error handling in Rust</a> by Armin Ronacher</li>
</ul>
<hr>
<p><small>
Code examples in this article were built with rustc 0.13.0-nightly.
</small></p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../book/day4.html" class="navigation navigation-prev " aria-label="Previous page: Day 4 - docopt"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../book/day6.html" class="navigation navigation-next " aria-label="Next page: Day 6 - working with JSON"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
