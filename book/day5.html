<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>Day 5 - hyper | 24daysofrust</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.0.1">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="../book/day6.html" />
    
    
    <link rel="prev" href="../book/day4.html" />
    

        
    </head>
    <body>
        
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
    

        
    <div class="book" data-level="5" data-basepath=".." data-revision="Tue Jul 07 2015 07:28:15 GMT+0000 (UTC)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        

        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="book/day1.html">
            
                
                    <a href="../book/day1.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Day 1 - Cargo and crates.io
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="book/day2.html">
            
                
                    <a href="../book/day2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Day 2 - primal
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="book/day3.html">
            
                
                    <a href="../book/day3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Day 3 - csv
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="book/day4.html">
            
                
                    <a href="../book/day4.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Day 4 - docopt
                    </a>
                
            
            
        </li>
    
        <li class="chapter active" data-level="5" data-path="book/day5.html">
            
                
                    <a href="../book/day5.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Day 5 - hyper
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="book/day6.html">
            
                
                    <a href="../book/day6.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Day 6 - working with JSON
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="book/day7.html">
            
                
                    <a href="../book/day7.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Day 7 - itertools
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="book/day8.html">
            
                
                    <a href="../book/day8.html">
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Day 8 - racer
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="book/day9.html">
            
                
                    <a href="../book/day9.html">
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        Day 9 - anymap
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="book/day10.html">
            
                
                    <a href="../book/day10.html">
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        Day 10 - the glorious tau
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="book/day11.html">
            
                
                    <a href="../book/day11.html">
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        Day 11 - postgres
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="book/day12.html">
            
                
                    <a href="../book/day12.html">
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        Day 12 - image
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="book/day13.html">
            
                
                    <a href="../book/day13.html">
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        Day 13 - uuid
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="book/day14.html">
            
                
                    <a href="../book/day14.html">
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        Day 14 - nalgebra
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="book/day15.html">
            
                
                    <a href="../book/day15.html">
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        Day 15 - FUSE filesystems, part 1
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="book/day16.html">
            
                
                    <a href="../book/day16.html">
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        Day 16 - FUSE filesystems, part 2
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="book/day17.html">
            
                
                    <a href="../book/day17.html">
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        Day 17 - from_fn
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="book/day18.html">
            
                
                    <a href="../book/day18.html">
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        Day 18 - redis
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="book/day19.html">
            
                
                    <a href="../book/day19.html">
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        Day 19 - rusti
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="book/day20.html">
            
                
                    <a href="../book/day20.html">
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        Day 20 - zeromq
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="book/day21.html">
            
                
                    <a href="../book/day21.html">
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        Day 21 - rust-crypto
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="book/day22.html">
            
                
                    <a href="../book/day22.html">
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        Day 22 - built with Rust
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="book/day23.html">
            
                
                    <a href="../book/day23.html">
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        Day 23 - calling Rust from other languages
                    </a>
                
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="book/day24.html">
            
                
                    <a href="../book/day24.html">
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                        Day 24 - conclusion
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                Published with GitBook
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >24daysofrust</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="day-5-hyper">Day 5 - hyper</h1>
<blockquote>
<p>Relevancy: 1.0 stable</p>
</blockquote>
<p>The state of HTTP libraries in Rust was a constant flux before 1.0. However it appears that a specific package won the hearts of Rust programmers: <a href="https://crates.io/crates/hyper" target="_blank">hyper</a>, which will be the subject of this chapter.</p>
<p>I&apos;m going to focus on using <code>hyper</code> only as a client, although the library contains also a server implementation. However with the advance of Rust web frameworks building on top of HTTP libraries, the programmers will focus less on developing servers and more on the clients. Consuming web APIs is a lot more common than writing new shiny servers. How can <code>hyper</code> help us?</p>
<h2 id="basic-requests">Basic requests</h2>
<p>Let&apos;s start from the usual dependency definition in <code>Cargo.toml</code>.</p>
<pre><code class="lang-ini"><span class="hljs-title">[dependencies]</span>
<span class="hljs-setting">hyper = <span class="hljs-value"><span class="hljs-string">&quot;~0.5&quot;</span></span></span>
</code></pre>
<p>When you run <code>cargo build</code>, Cargo will download a few other required crates (for URL handling, mimetype support, OpenSSL bindings etc.) and hopefully compile <code>hyper</code> afterwards. Time for our first request!</p>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> hyper;

<span class="hljs-keyword">use</span> std::io::Read;
<span class="hljs-keyword">use</span> hyper::{Client};

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> client = Client::new();
    <span class="hljs-keyword">let</span> url = <span class="hljs-string">&quot;http://httpbin.org/status/201&quot;</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> response = <span class="hljs-keyword">match</span> client.get(url).send() {
        Ok(response) =&gt; response,
        Err(<span class="hljs-number">_</span>) =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;Whoops.&quot;</span>),
    };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> buf = String::new();
    <span class="hljs-keyword">match</span> response.read_to_string(&amp;<span class="hljs-keyword">mut</span> buf) {
        Ok(<span class="hljs-number">_</span>) =&gt; (),
        Err(<span class="hljs-number">_</span>) =&gt; <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;I give up.&quot;</span>),
    };
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;buf: {}&quot;</span>, buf);
}
</code></pre>
<p>That was... <em>verbose</em>. I could just use <code>unwrap()</code> everywhere, but that would be handwaving and in poor taste. Sprinkling your code with <code>panic!</code> is not a sign of good style too. However, there are so many things that can go wrong during an HTTP request/response cycle! But there seems to be a pattern. Can we do better?</p>
<pre><code class="lang-rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_content</span></span>(url: &amp;<span class="hljs-keyword">str</span>) -&gt; hyper::Result&lt;String&gt; {
    <span class="hljs-keyword">let</span> client = Client::new();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> response = <span class="hljs-built_in">try!</span>(client.get(url).send());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> buf = String::new();
    <span class="hljs-built_in">try!</span>(response.read_to_string(&amp;<span class="hljs-keyword">mut</span> buf));
    Ok(buf)
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{}&quot;</span>, get_content(<span class="hljs-string">&quot;http://httpbin.org/status/200&quot;</span>));
}
</code></pre>
<p>We refactored the request cycle into a separate function. But look how the code got simpler, thanks to the <a href="http://doc.rust-lang.org/std/result/#the-try!-macro" target="_blank">try! macro</a>. There&apos;s no explicit matching on the <code>Result</code> variants and the first <code>try!</code> that fails will return from the function with some kind of an HTTP error.</p>
<h2 id="post-and-query-parameters">POST and query parameters</h2>
<p>Sending POST requests with hyper is only a little bit more complicated. We&apos;ll write a wrapper function again, this time taking an additional argument of type <code>Query</code>.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> url;

<span class="hljs-keyword">use</span> url::form_urlencoded;

<span class="hljs-keyword">type</span> <span class="hljs-title">Query</span>&lt;&apos;a&gt; = Vec&lt;(&amp;&apos;a <span class="hljs-keyword">str</span>, &amp;&apos;a <span class="hljs-keyword">str</span>)&gt;;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">post_query</span></span>(url: &amp;<span class="hljs-keyword">str</span>, query: Query) -&gt; hyper::Result&lt;String&gt; {
    <span class="hljs-keyword">let</span> client = Client::new();
    <span class="hljs-keyword">let</span> body = form_urlencoded::serialize(query);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> response = <span class="hljs-built_in">try!</span>(client.post(url).body(&amp;body[..]).send());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> buf = String::new();
    <span class="hljs-built_in">try!</span>(response.read_to_string(&amp;<span class="hljs-keyword">mut</span> buf));
    Ok(buf)
}

<span class="hljs-keyword">let</span> query = <span class="hljs-built_in">vec!</span>[(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>), (<span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>)];
<span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{}&quot;</span>, post_query(<span class="hljs-string">&quot;http://httpbin.org/post&quot;</span>, query).unwrap());
</code></pre>
<p>The main difference from <code>get_content()</code> is the serialization machinery coming from the <a href="https://crates.io/crates/url" target="_blank">url</a> crate. Once we&apos;ve built a raw request body (like <code>key=value&amp;foo=bar</code>), we pass it to the <code>body()</code> method and the rest is identical to the GET example above.</p>
<h2 id="sending-json">Sending JSON</h2>
<p>Our <code>post_query</code> function can be easily changed to borrow a struct, serialize it to JSON and send it over the wire.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rustc_serialize;

<span class="hljs-keyword">use</span> rustc_serialize::{Encodable, json};

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">post_json</span></span>&lt;T&gt;(url: &amp;<span class="hljs-keyword">str</span>, payload: &amp;T) -&gt; hyper::Result&lt;String&gt;
    where T: Encodable {
    <span class="hljs-keyword">let</span> body = json::encode(payload).unwrap();
    <span class="hljs-comment">// rest of the code as before</span>
}
</code></pre>
<p>This function is generic in its <code>payload</code> argument, accepting anything that implements the <code>Encodable</code> trait. We can use the function as follows:</p>
<pre><code class="lang-rust"><span class="hljs-preprocessor">#[derive(RustcDecodable, RustcEncodable)]</span>
<span class="hljs-keyword">struct</span> Movie {
    title: String,
    bad_guy: String,
    pub_year: usize,
}

<span class="hljs-keyword">let</span> movie = Movie {
    title: <span class="hljs-string">&quot;You Only Live Twice&quot;</span>.to_string(),
    bad_guy: <span class="hljs-string">&quot;Blofeld&quot;</span>.to_string(),
    pub_year: <span class="hljs-number">1967</span>,
};
<span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{:?}&quot;</span>, post_json(<span class="hljs-string">&quot;http://httpbin.org/post&quot;</span>, &amp;movie).unwrap());
</code></pre>
<h2 id="see-also">See also</h2>
<ul>
<li><a href="https://github.com/servo/servo/wiki/HTTP-library-requirements" target="_blank">HTTP library requirements</a> from the Servo project</li>
<li><a href="https://github.com/jgillich/rust-request" target="_blank">rust-request</a> - a HTTP client library written on top of hyper</li>
<li><a href="https://github.com/gtolle/rest_client" target="_blank">rest_client</a> - another HTTP client built with hyper</li>
<li><a href="http://lucumr.pocoo.org/2014/11/6/error-handling-in-rust/" target="_blank">Improved error handling in Rust</a> by Armin Ronacher</li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../book/day4.html" class="navigation navigation-prev " aria-label="Previous page: Day 4 - docopt"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../book/day6.html" class="navigation navigation-next " aria-label="Next page: Day 6 - working with JSON"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
