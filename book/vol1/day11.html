<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Day 11 - postgres | 24 days of Rust</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../book/vol1/day12.html" />
    
    
    <link rel="prev" href="../../book/vol1/day10.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="1.11"
        data-chapter-title="Day 11 - postgres"
        data-filepath="book/vol1/day11.md"
        data-basepath="../.."
        data-revision="Tue Dec 20 2016 19:18:04 GMT+0000 (UTC)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="book/vol1/index.html">
            
                
                    <a href="../../book/vol1/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Volume 1
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="book/vol1/day1.html">
            
                
                    <a href="../../book/vol1/day1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Day 1 - Cargo and crates.io
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="book/vol1/day2.html">
            
                
                    <a href="../../book/vol1/day2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Day 2 - primal
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="book/vol1/day3.html">
            
                
                    <a href="../../book/vol1/day3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Day 3 - csv
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="book/vol1/day4.html">
            
                
                    <a href="../../book/vol1/day4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Day 4 - docopt
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="book/vol1/day5.html">
            
                
                    <a href="../../book/vol1/day5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Day 5 - hyper
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="book/vol1/day6.html">
            
                
                    <a href="../../book/vol1/day6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                        Day 6 - working with JSON
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="book/vol1/day7.html">
            
                
                    <a href="../../book/vol1/day7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                        Day 7 - itertools
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="book/vol1/day8.html">
            
                
                    <a href="../../book/vol1/day8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                        Day 8 - racer
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="book/vol1/day9.html">
            
                
                    <a href="../../book/vol1/day9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                        Day 9 - anymap
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="book/vol1/day10.html">
            
                
                    <a href="../../book/vol1/day10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.</b>
                        
                        Day 10 - the glorious tau
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="1.11" data-path="book/vol1/day11.html">
            
                
                    <a href="../../book/vol1/day11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.11.</b>
                        
                        Day 11 - postgres
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="book/vol1/day12.html">
            
                
                    <a href="../../book/vol1/day12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.12.</b>
                        
                        Day 12 - image
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="book/vol1/day13.html">
            
                
                    <a href="../../book/vol1/day13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.13.</b>
                        
                        Day 13 - uuid
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="book/vol1/day14.html">
            
                
                    <a href="../../book/vol1/day14.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.14.</b>
                        
                        Day 14 - nalgebra
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="book/vol1/day15.html">
            
                
                    <a href="../../book/vol1/day15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.15.</b>
                        
                        Day 15 - FUSE filesystems, part 1
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="book/vol1/day16.html">
            
                
                    <a href="../../book/vol1/day16.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.16.</b>
                        
                        Day 16 - FUSE filesystems, part 2
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="book/vol1/day17.html">
            
                
                    <a href="../../book/vol1/day17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.17.</b>
                        
                        Day 17 - from_fn
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="book/vol1/day18.html">
            
                
                    <a href="../../book/vol1/day18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.18.</b>
                        
                        Day 18 - redis
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="book/vol1/day19.html">
            
                
                    <a href="../../book/vol1/day19.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.19.</b>
                        
                        Day 19 - rusti
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.20" data-path="book/vol1/day20.html">
            
                
                    <a href="../../book/vol1/day20.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.20.</b>
                        
                        Day 20 - zeromq
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.21" data-path="book/vol1/day21.html">
            
                
                    <a href="../../book/vol1/day21.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.21.</b>
                        
                        Day 21 - rust-crypto
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.22" data-path="book/vol1/day22.html">
            
                
                    <a href="../../book/vol1/day22.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.22.</b>
                        
                        Day 22 - built with Rust
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.23" data-path="book/vol1/day23.html">
            
                
                    <a href="../../book/vol1/day23.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.23.</b>
                        
                        Day 23 - calling Rust from other languages
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.24" data-path="book/vol1/day24.html">
            
                
                    <a href="../../book/vol1/day24.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.24.</b>
                        
                        Day 24 - conclusion
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="book/vol2/index.html">
            
                
                    <a href="../../book/vol2/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Volume 2
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="book/vol2/day1.html">
            
                
                    <a href="../../book/vol2/day1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Day 1 - cargo subcommands
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="book/vol2/day2.html">
            
                
                    <a href="../../book/vol2/day2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Day 2 - hound
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="book/vol2/day3.html">
            
                
                    <a href="../../book/vol2/day3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Day 3 - rayon
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="book/vol2/day4.html">
            
                
                    <a href="../../book/vol2/day4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Day 4 - structured logging
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="book/vol2/day5.html">
            
                
                    <a href="../../book/vol2/day5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        Day 5 - environment variables
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="book/vol2/day6.html">
            
                
                    <a href="../../book/vol2/day6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                        Day 6 - derive_builder
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="book/vol2/day7.html">
            
                
                    <a href="../../book/vol2/day7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.7.</b>
                        
                        Day 7 - static initialization
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="book/vol2/day8.html">
            
                
                    <a href="../../book/vol2/day8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.8.</b>
                        
                        Day 8 - serde
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="book/vol2/day9.html">
            
                
                    <a href="../../book/vol2/day9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.9.</b>
                        
                        Day 9 - winreg
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="book/vol2/day10.html">
            
                
                    <a href="../../book/vol2/day10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.10.</b>
                        
                        Day 10 - nom, part 1
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.11" data-path="book/vol2/day11.html">
            
                
                    <a href="../../book/vol2/day11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.11.</b>
                        
                        Day 11 - nom, part 2
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.12" data-path="book/vol2/day12.html">
            
                
                    <a href="../../book/vol2/day12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.12.</b>
                        
                        Day 12 - clap
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.13" data-path="book/vol2/day13.html">
            
                
                    <a href="../../book/vol2/day13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.13.</b>
                        
                        Day 13 - zip and lzma compression
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.14" data-path="book/vol2/day14.html">
            
                
                    <a href="../../book/vol2/day14.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.14.</b>
                        
                        Day 14 - Cursive
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.15" data-path="book/vol2/day15.html">
            
                
                    <a href="../../book/vol2/day15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.15.</b>
                        
                        Day 15 - tera
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.16" data-path="book/vol2/day16.html">
            
                
                    <a href="../../book/vol2/day16.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.16.</b>
                        
                        Day 16 - git2
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.17" data-path="book/vol2/day17.html">
            
                
                    <a href="../../book/vol2/day17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.17.</b>
                        
                        Day 17 - diesel
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.18" data-path="book/vol2/day18.html">
            
                
                    <a href="../../book/vol2/day18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.18.</b>
                        
                        Day 18 - error_chain
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.19" data-path="book/vol2/day19.html">
            
                
                    <a href="../../book/vol2/day19.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.19.</b>
                        
                        Day 19 - leftpad
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.20" data-path="book/vol2/day20.html">
            
                
                    <a href="../../book/vol2/day20.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.20.</b>
                        
                        Day 20 - reqwest
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >24 days of Rust</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="day-11--postgres">Day 11 - postgres</h1>
<blockquote>
<p>Relevancy: 1.9 stable (macros only on nightly)</p>
</blockquote>
<p>Yes, I&apos;m biased. <a href="http://www.postgresql.org/" target="_blank">PostgreSQL</a> is my favorite SQL database. There is already a pure Rust driver for PostgreSQL - the <a href="https://crates.io/crates/postgres" target="_blank">postgres</a> crate which will be the subject of today&apos;s article.</p>
<h2 id="connecting">Connecting</h2>
<p>In this and the following examples we will assume a Postgres user <code>rust</code> with password <code>rust</code> and an existing database named... well, <code>rust</code>.</p>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> time;
</code></pre>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust">

</code></pre>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;24 days of Rust - postgres (day 11)&quot;</span>);
    <span class="hljs-keyword">let</span> dsn = <span class="hljs-string">&quot;postgresql://rust:rust@localhost/rust&quot;</span>;
    <span class="hljs-keyword">let</span> conn = <span class="hljs-keyword">match</span> Connection::connect(dsn, TlsMode::<span class="hljs-built_in">None</span>) {
        <span class="hljs-built_in">Ok</span>(conn) =&gt; conn,
        <span class="hljs-built_in">Err</span>(e) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Connection error: {:?}&quot;</span>, e);
            <span class="hljs-keyword">return</span>;
        }
</code></pre>
<p>The <code>Connection</code> type has a few methods related to making queries; perhaps the simplest one is <code>execute()</code> which immediately executes the query and returns the number of modified rows (or an error). This method can be used for example for insert/update queries but also DDL as shown below.</p>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust">};
    conn.execute(<span class="hljs-string">&quot;create table if not exists blog (
        id serial primary key,
        title \
                  varchar(255),
        body text)&quot;</span>,
                 &amp;[])
</code></pre>
<p>The second argument looks slightly awkward, but that&apos;s the way of telling <code>execute()</code> that the query takes no parameters. Later on we will see a few examples that use query parameters.</p>
<h2 id="prepared-queries-and-statements">Prepared queries and statements</h2>
<p>Let&apos;s add a few rows to our table. We will use the <code>prepare()</code> method.</p>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust">.expect(<span class="hljs-string">&quot;Table creation failed&quot;</span>);
    <span class="hljs-keyword">let</span> stmt = <span class="hljs-keyword">match</span> conn.prepare(<span class="hljs-string">&quot;insert into blog (title, body) values ($1, $2)&quot;</span>) {
        <span class="hljs-built_in">Ok</span>(stmt) =&gt; stmt,
        <span class="hljs-built_in">Err</span>(e) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Preparing query failed: {:?}&quot;</span>, e);
            <span class="hljs-keyword">return</span>;
        }
    };
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span>..<span class="hljs-number">5</span> {
        <span class="hljs-keyword">let</span> title = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;Blogpost number {}&quot;</span>, i);
        <span class="hljs-keyword">let</span> text = <span class="hljs-built_in">format!</span>(<span class="hljs-string">&quot;Content of the blogpost #{}&quot;</span>, i);
        stmt.execute(&amp;[&amp;title, &amp;text]).expect(<span class="hljs-string">&quot;Inserting blogposts failed&quot;</span>);
</code></pre>
<p>The query was prepared only once and what we got (after some crude error handling) is a <code>Statement</code> value. We can use its <code>execute()</code> method to actually run the query with the supplied parameters (note the borrowing).</p>
<p>To read the data from the database we will use the same <code>prepare()</code> method in conjunction with the <code>query()</code> method of a <code>Statement</code>. There&apos;s a significant difference between <code>execute()</code> and <code>query()</code>: the former returns just the number of affected rows, while the latter returns a collection of <code>Row</code> values.</p>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust">}
    <span class="hljs-keyword">let</span> stmt = <span class="hljs-keyword">match</span> conn.prepare(<span class="hljs-string">&quot;select id, title, body from blog where id &lt; $1&quot;</span>) {
        <span class="hljs-built_in">Ok</span>(stmt) =&gt; stmt,
        <span class="hljs-built_in">Err</span>(e) =&gt; {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Preparing query failed: {:?}&quot;</span>, e);
            <span class="hljs-keyword">return</span>;
        }
    };
    <span class="hljs-keyword">let</span> max_id: <span class="hljs-keyword">i32</span> = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">let</span> rows = stmt.query(&amp;[&amp;max_id]).expect(<span class="hljs-string">&quot;Selecting blogposts failed&quot;</span>);
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows.iter() {
        <span class="hljs-keyword">let</span> id: <span class="hljs-keyword">i32</span> = row.get(<span class="hljs-string">&quot;id&quot;</span>);
        <span class="hljs-keyword">let</span> title: <span class="hljs-built_in">String</span> = row.get(<span class="hljs-string">&quot;title&quot;</span>);
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;ID={}, title={}&quot;</span>, id, title);
</code></pre>
<p>Keep in mind that the <code>get()</code> method will panic if it encounters incompatible types, for example if we changed <code>String</code> to <code>i32</code> above. There&apos;s also a safer <code>get_opt()</code> method returning a <code>Result</code> instead of panicking.</p>
<h2 id="advanced-postgresql-types">Advanced PostgreSQL types</h2>
<p>All this is a bit boring so far. One of the reasons developers love PostgreSQL is its selection of interesting data types. Let&apos;s see how to use them in Rust (hint: it&apos;s kinda cool). We&apos;ll start from writing a generic helper function to read a single value from the first column of the first row.</p>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> postgres::{Connection, TlsMode};
<span class="hljs-keyword">use</span> postgres::types::FromSql;
</code></pre>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">get_single_value</span></span>&lt;T&gt;(conn: &amp;Connection, query: &amp;<span class="hljs-keyword">str</span>) -&gt; PgResult&lt;T&gt;
    <span class="hljs-keyword">where</span> T: FromSql
{
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Executing query: {}&quot;</span>, query);
    <span class="hljs-keyword">let</span> stmt = <span class="hljs-built_in">try!</span>(conn.prepare(query));
    <span class="hljs-keyword">let</span> rows = <span class="hljs-built_in">try!</span>(stmt.query(&amp;[]));
    <span class="hljs-keyword">let</span> row = rows.iter().next().unwrap();
    row.get_opt(<span class="hljs-number">0</span>).unwrap()
</code></pre>
<p>We use the <code>try!</code> macro to minimize the noise from error handling. Now let&apos;s see it in action. The more interesting types like arrays, ranges etc. come from a few additional crates: <a href="https://crates.io/crates/postgres_array" target="_blank">postgres_array</a> and <a href="https://crates.io/crates/postgres_range" target="_blank">postgres_range</a>.</p>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rustc_serialize;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> time;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> postgres;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> postgres_array;
</code></pre>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> postgres::<span class="hljs-built_in">Result</span> <span class="hljs-keyword">as</span> PgResult;
<span class="hljs-keyword">use</span> postgres_array::Array;
<span class="hljs-comment">// use postgres_range::Range;</span>

<span class="hljs-keyword">use</span> rustc_serialize::json::Json;
</code></pre>
<blockquote>
<p><a id="day11.rs" href="../../vol1/src/day11.rs">day11.rs</a></p>
</blockquote>
<pre><code class="lang-rust">}
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{:?}&quot;</span>, get_single_value::&lt;<span class="hljs-keyword">bool</span>&gt;(&amp;conn, <span class="hljs-string">&quot;select 1=1&quot;</span>));
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{:?}&quot;</span>, get_single_value::&lt;<span class="hljs-keyword">i32</span>&gt;(&amp;conn, <span class="hljs-string">&quot;select 1=1&quot;</span>));

    <span class="hljs-keyword">type</span> <span class="hljs-title">IntArray</span> = Array&lt;<span class="hljs-built_in">Option</span>&lt;<span class="hljs-keyword">i32</span>&gt;&gt;;
    <span class="hljs-keyword">let</span> arr = get_single_value::&lt;IntArray&gt;(&amp;conn, <span class="hljs-string">&quot;select &apos;{4, 5, 6}&apos;::int[]&quot;</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{:?}&quot;</span>,
             arr.map(|arr| {
                 arr.iter()
                     .filter_map(|x| *x)
                     .collect::&lt;<span class="hljs-built_in">Vec</span>&lt;_&gt;&gt;()
             }));

    <span class="hljs-keyword">let</span> json = get_single_value::&lt;Json&gt;(&amp;conn, <span class="hljs-string">&quot;select &apos;{\&quot;foo\&quot;: \&quot;bar\&quot;, \&quot;answer\&quot;: 42}&apos;::json&quot;</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{:?}&quot;</span>, json);

    <span class="hljs-comment">// let range = get_single_value::&lt;Range&lt;i32&gt;&gt;(&amp;conn, &quot;select &apos;[10, 20)&apos;::int4range&quot;);</span>
    <span class="hljs-comment">// println!(&quot;{:?}&quot;, range);</span>
    <span class="hljs-comment">// let ts_range =</span>
    <span class="hljs-comment">// get_single_value::&lt;Range&lt;Timespec&gt;&gt;(&amp;conn, &quot;select &apos;[2015-01-01, 2015-12-31]&apos;::tsrange&quot;);</span>
    <span class="hljs-comment">// println!(&quot;{:?}&quot;, ts_range);</span>
</code></pre>
<pre><code class="lang-sh">$ cargo run
Executing query: select <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
Ok(<span class="hljs-literal">true</span>)
Executing query: select <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
Err(WrongType(Bool))
Executing query: select <span class="hljs-string">&apos;{4, 5, 6}&apos;</span>::int[]
Ok([<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])
Executing query: select <span class="hljs-string">&apos;{&quot;foo&quot;: &quot;bar&quot;, &quot;answer&quot;: 42}&apos;</span>::json
Ok(Object({<span class="hljs-string">&quot;answer&quot;</span>: U64(<span class="hljs-number">42</span>), <span class="hljs-string">&quot;foo&quot;</span>: String(<span class="hljs-string">&quot;bar&quot;</span>)}))
Executing query: select <span class="hljs-string">&apos;[10, 20)&apos;</span>::int4range
Ok([<span class="hljs-number">10</span>,<span class="hljs-number">20</span>))
Executing query: select <span class="hljs-string">&apos;[2015-01-01, 2015-12-31]&apos;</span>::tsrange
Ok([Timespec { sec: <span class="hljs-number">1420070400</span>, nsec: <span class="hljs-number">0</span> },Timespec { sec: <span class="hljs-number">1451520000</span>, nsec: <span class="hljs-number">0</span> }])
</code></pre>
<p>Fantastic! The error handling is still there when we need it and we get values of reasonable Rust types.</p>
<h2 id="compiletime-sql-checking">Compile-time SQL checking</h2>
<p>There is another crate worth mentioning here - <a href="https://crates.io/crates/postgres_macros" target="_blank">postgres_macros</a>. It provides the <code>sql!</code> macro that validates correctness of the SQL query given as argument <strong>at compile time</strong>.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> query = sql!(<span class="hljs-string">&quot;select &apos;{4, 5, 6}&apos;::int[]&quot;</span>);
<span class="hljs-keyword">let</span> this_wont_compile = sql!(<span class="hljs-string">&quot;eslect &apos;{4, 5, 6}&apos;::int[]&quot;</span>);
</code></pre>
<h2 id="see-also">See also</h2>
<ul>
<li><a href="https://github.com/deuterium-orm/deuterium-orm" target="_blank">deuterium-orm</a> - a basic ORM for Rust supporting PostgreSQL</li>
<li><a href="https://crates.io/crates/r2d2" target="_blank">r2d2</a> - a generic connection pool with <a href="https://crates.io/crates/r2d2_postgres" target="_blank">Postgres support</a></li>
<li><a href="http://blog.bguiz.com/2014/08/05/restful-api-in-rust-with-nickel-postgres/" target="_blank">Building RESTful API server in Rust with nickel-postgres</a></li>
<li><a href="https://github.com/thehydroimpulse/postgres-extension.rs" target="_blank">Writing Postgres extensions in Rust</a></li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../book/vol1/day10.html" class="navigation navigation-prev " aria-label="Previous page: Day 10 - the glorious tau"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../book/vol1/day12.html" class="navigation navigation-next " aria-label="Next page: Day 12 - image"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"include-codeblock":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
