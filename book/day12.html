<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Day 12 - image | 24 days of Rust</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../book/day13.html" />
    
    
    <link rel="prev" href="../book/day11.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="12"
        data-chapter-title="Day 12 - image"
        data-filepath="book/day12.md"
        data-basepath=".."
        data-revision="Wed Jul 20 2016 11:48:52 GMT+0000 (UTC)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="book/day1.html">
            
                
                    <a href="../book/day1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Day 1 - Cargo and crates.io
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="book/day2.html">
            
                
                    <a href="../book/day2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Day 2 - primal
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="book/day3.html">
            
                
                    <a href="../book/day3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Day 3 - csv
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="book/day4.html">
            
                
                    <a href="../book/day4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Day 4 - docopt
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="book/day5.html">
            
                
                    <a href="../book/day5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Day 5 - hyper
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="book/day6.html">
            
                
                    <a href="../book/day6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Day 6 - working with JSON
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="book/day7.html">
            
                
                    <a href="../book/day7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Day 7 - itertools
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="book/day8.html">
            
                
                    <a href="../book/day8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Day 8 - racer
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="book/day9.html">
            
                
                    <a href="../book/day9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        Day 9 - anymap
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="book/day10.html">
            
                
                    <a href="../book/day10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        Day 10 - the glorious tau
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="book/day11.html">
            
                
                    <a href="../book/day11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        Day 11 - postgres
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="12" data-path="book/day12.html">
            
                
                    <a href="../book/day12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        Day 12 - image
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="book/day13.html">
            
                
                    <a href="../book/day13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        Day 13 - uuid
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="book/day14.html">
            
                
                    <a href="../book/day14.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        Day 14 - nalgebra
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="book/day15.html">
            
                
                    <a href="../book/day15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        Day 15 - FUSE filesystems, part 1
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="book/day16.html">
            
                
                    <a href="../book/day16.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        Day 16 - FUSE filesystems, part 2
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="book/day17.html">
            
                
                    <a href="../book/day17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        Day 17 - from_fn
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="book/day18.html">
            
                
                    <a href="../book/day18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        Day 18 - redis
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="book/day19.html">
            
                
                    <a href="../book/day19.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        Day 19 - rusti
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="book/day20.html">
            
                
                    <a href="../book/day20.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        Day 20 - zeromq
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="book/day21.html">
            
                
                    <a href="../book/day21.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        Day 21 - rust-crypto
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="book/day22.html">
            
                
                    <a href="../book/day22.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        Day 22 - built with Rust
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="book/day23.html">
            
                
                    <a href="../book/day23.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        Day 23 - calling Rust from other languages
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="book/day24.html">
            
                
                    <a href="../book/day24.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                        Day 24 - conclusion
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >24 days of Rust</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="day-12--image">Day 12 - image</h1>
<blockquote>
<p>Relevancy: 1.9 stable</p>
</blockquote>
<p>The <a href="https://crates.io/crates/image" target="_blank">image</a> crate is a library under development (well, not unlike the rest of the Rust ecosystem before 1.0) to read, manipulate and write images. It is part of the effort to develop an open source game engine in pure Rust - <a href="http://www.piston.rs/" target="_blank">Piston</a>, but of course the <code>image</code> crate can be used on its own.</p>
<p>At the moment <code>image</code> supports reading and writing JPG, GIF and PNG images, while a few other formats are read-only (TIFF, WEBP).</p>
<h2 id="basics">Basics</h2>
<p>Let&apos;s start from something simple - read a JPEG image, flip it horizontally and save as PNG.</p>
<blockquote>
<p><a id="day12.rs" href="../src/day12.rs">day12.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> image;
</code></pre>
<blockquote>
<p><a id="day12.rs" href="../src/day12.rs">day12.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> std::fs::File;
</code></pre>
<blockquote>
<p><a id="day12.rs" href="../src/day12.rs">day12.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> img = image::open(<span class="hljs-string">&quot;data/in.png&quot;</span>).expect(<span class="hljs-string">&quot;Opening image failed&quot;</span>);
    <span class="hljs-keyword">let</span> filtered = img.fliph();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> out = File::create(<span class="hljs-string">&quot;out.png&quot;</span>).unwrap();
    filtered.save(&amp;<span class="hljs-keyword">mut</span> out, image::PNG).expect(<span class="hljs-string">&quot;Saving image failed&quot;</span>);
</code></pre>
<p>We used the <code>open()</code> function to create the <code>img</code> variable (which is a <a href="http://www.piston.rs/image/image/enum.DynamicImage.html" target="_blank">DynamicImage</a> value). This is a wrapper for the <code>load()</code> function, which can read images from anything that implements the <code>Read</code> trait. However, there&apos;s no symmetrical shortcut to write an image, so we take advantage of the fact that <code>File</code> implements <code>Write</code>. In between, the <code>fliph()</code> method of the image does what it says on the cover. There are other transformations available, such as:</p>
<ul>
<li><code>fliph()</code></li>
<li><code>flipv()</code></li>
<li><code>rotateN()</code> where N is 90, 180 or 270</li>
<li><code>blur(sigma)</code></li>
<li><code>invert()</code></li>
<li><code>grayscale()</code></li>
</ul>
<p>and a few others. All these return a new image, except <code>invert()</code>.</p>
<h2 id="edge-detection">Edge detection</h2>
<p>The <code>image</code> API lets us run arbitrary 3x3 <a href="http://www.roborealm.com/help/Convolution.php" target="_blank">convolution filters</a>. We can use it to create a very basic edge detection filter.</p>
<blockquote>
<p><a id="day12.rs" href="../src/day12.rs">day12.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> kernel = [-<span class="hljs-number">1.0f32</span>, -<span class="hljs-number">1.0</span>, -<span class="hljs-number">1.0</span>,
                  -<span class="hljs-number">1.0</span>, <span class="hljs-number">8.0</span>, -<span class="hljs-number">1.0</span>,
                  -<span class="hljs-number">1.0</span>, -<span class="hljs-number">1.0</span>, -<span class="hljs-number">1.0</span>];
    <span class="hljs-keyword">let</span> filtered = img.filter3x3(&amp;kernel);
</code></pre>
<p>To honour the image processing tradition, our input image is <a href="http://en.wikipedia.org/wiki/Lenna" target="_blank">a photo of Lena S&#xF6;derberg</a>. Here&apos;s the result:</p>
<p><img src="../../../../../../i.imgur.com/D1mMwhK.jpg" alt="edgy Lena"></p>
<h2 id="directly-manipulating-pixels">Directly manipulating pixels</h2>
<p>A typical example of looping over image pixels is to add some noise to the image. The noise does not depend on surrounding pixels, so the inner loop is very simple - generate a Gaussian noise sample and add it to the current pixel.</p>
<blockquote>
<p><a id="day12.rs" href="../src/day12.rs">day12.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> (width, height) = img.dimensions();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> rng = rand::thread_rng();
    <span class="hljs-keyword">let</span> normal = Normal::new(<span class="hljs-number">15.0</span>, <span class="hljs-number">15.0</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> noisy = img.brighten(-<span class="hljs-number">25</span>);
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..(width) {
        <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..(height) {
            <span class="hljs-keyword">let</span> offset = normal.ind_sample(&amp;<span class="hljs-keyword">mut</span> rng) <span class="hljs-keyword">as</span> <span class="hljs-keyword">u8</span>;
            <span class="hljs-keyword">let</span> px = img.get_pixel(x, y).map(|v| <span class="hljs-keyword">if</span> v &lt;= <span class="hljs-number">255</span> - offset { v + offset } <span class="hljs-keyword">else</span> { <span class="hljs-number">255</span> });
            noisy.put_pixel(x, y, px);
        }
    }
</code></pre>
<p>We need to use the <code>GenericImage</code> and <code>Pixel</code> traits to introduce some extra methods we&apos;re going to use later.</p>
<p>Each run of the inner loop generates a sample from the normal distribution. We then pick one pixel from the original image with <code>get_pixel()</code>, add the offset to every channel (that&apos;s what the <code>map()</code> method does for types implementing <code>Pixel</code> trait) and store the pixel in the new image.</p>
<p><img src="../../../../../../i.imgur.com/Zu7jnIK.jpg" alt="noisy Lena"></p>
<h2 id="thumbnails">Thumbnails</h2>
<p>To create a thumbnail from the image, use it&apos;s <code>resize()</code> method. It takes three arguments: width and height of the thumbnail (but the original aspect ratio will be preserved, so one of these dimensions might be ignored) and a variant of the <code>FilterType</code> enum. This value dictates what interpolation to use when resizing. See for example the <a href="http://docs.gimp.org/en/gimp-tools-transform.html" target="_blank">GIMP documentation</a> to learn more about various methods. I personally like Lanczos interpolation, unless the result looks really bad.</p>
<blockquote>
<p><a id="day12.rs" href="../src/day12.rs">day12.rs</a></p>
</blockquote>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> thumbnail = img.resize(<span class="hljs-number">120</span>, <span class="hljs-number">120</span>, FilterType::Lanczos3);
</code></pre>
<p>One more thing - if your code using the <code>image</code> crate seems to be pretty slow, double check that you run in release mode (with compiler optimizations). For Cargo, that means <code>cargo run --release</code>. In my case the change from the default (no optimization) to release mode resulted in an 8-10x increase in speed.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../book/day11.html" class="navigation navigation-prev " aria-label="Previous page: Day 11 - postgres"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../book/day13.html" class="navigation navigation-next " aria-label="Next page: Day 13 - uuid"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"include-codeblock":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
