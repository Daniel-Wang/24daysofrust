<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Day 2 - hound | 24 days of Rust</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../../book/vol2/day3.html" />
    
    
    <link rel="prev" href="../../book/vol2/day1.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="2.2"
        data-chapter-title="Day 2 - hound"
        data-filepath="book/vol2/day2.md"
        data-basepath="../.."
        data-revision="Mon Dec 19 2016 18:25:03 GMT+0000 (UTC)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="book/vol1/index.html">
            
                
                    <a href="../../book/vol1/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Volume 1
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="book/vol1/day1.html">
            
                
                    <a href="../../book/vol1/day1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Day 1 - Cargo and crates.io
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="book/vol1/day2.html">
            
                
                    <a href="../../book/vol1/day2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Day 2 - primal
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="book/vol1/day3.html">
            
                
                    <a href="../../book/vol1/day3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Day 3 - csv
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="book/vol1/day4.html">
            
                
                    <a href="../../book/vol1/day4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Day 4 - docopt
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="book/vol1/day5.html">
            
                
                    <a href="../../book/vol1/day5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Day 5 - hyper
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="book/vol1/day6.html">
            
                
                    <a href="../../book/vol1/day6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                        Day 6 - working with JSON
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="book/vol1/day7.html">
            
                
                    <a href="../../book/vol1/day7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                        Day 7 - itertools
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="book/vol1/day8.html">
            
                
                    <a href="../../book/vol1/day8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                        Day 8 - racer
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="book/vol1/day9.html">
            
                
                    <a href="../../book/vol1/day9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                        Day 9 - anymap
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="book/vol1/day10.html">
            
                
                    <a href="../../book/vol1/day10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.</b>
                        
                        Day 10 - the glorious tau
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="book/vol1/day11.html">
            
                
                    <a href="../../book/vol1/day11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.11.</b>
                        
                        Day 11 - postgres
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="book/vol1/day12.html">
            
                
                    <a href="../../book/vol1/day12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.12.</b>
                        
                        Day 12 - image
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="book/vol1/day13.html">
            
                
                    <a href="../../book/vol1/day13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.13.</b>
                        
                        Day 13 - uuid
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="book/vol1/day14.html">
            
                
                    <a href="../../book/vol1/day14.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.14.</b>
                        
                        Day 14 - nalgebra
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="book/vol1/day15.html">
            
                
                    <a href="../../book/vol1/day15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.15.</b>
                        
                        Day 15 - FUSE filesystems, part 1
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="book/vol1/day16.html">
            
                
                    <a href="../../book/vol1/day16.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.16.</b>
                        
                        Day 16 - FUSE filesystems, part 2
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="book/vol1/day17.html">
            
                
                    <a href="../../book/vol1/day17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.17.</b>
                        
                        Day 17 - from_fn
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="book/vol1/day18.html">
            
                
                    <a href="../../book/vol1/day18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.18.</b>
                        
                        Day 18 - redis
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="book/vol1/day19.html">
            
                
                    <a href="../../book/vol1/day19.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.19.</b>
                        
                        Day 19 - rusti
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.20" data-path="book/vol1/day20.html">
            
                
                    <a href="../../book/vol1/day20.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.20.</b>
                        
                        Day 20 - zeromq
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.21" data-path="book/vol1/day21.html">
            
                
                    <a href="../../book/vol1/day21.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.21.</b>
                        
                        Day 21 - rust-crypto
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.22" data-path="book/vol1/day22.html">
            
                
                    <a href="../../book/vol1/day22.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.22.</b>
                        
                        Day 22 - built with Rust
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.23" data-path="book/vol1/day23.html">
            
                
                    <a href="../../book/vol1/day23.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.23.</b>
                        
                        Day 23 - calling Rust from other languages
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.24" data-path="book/vol1/day24.html">
            
                
                    <a href="../../book/vol1/day24.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.24.</b>
                        
                        Day 24 - conclusion
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="book/vol2/index.html">
            
                
                    <a href="../../book/vol2/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Volume 2
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="book/vol2/day1.html">
            
                
                    <a href="../../book/vol2/day1.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Day 1 - cargo subcommands
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.2" data-path="book/vol2/day2.html">
            
                
                    <a href="../../book/vol2/day2.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Day 2 - hound
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="book/vol2/day3.html">
            
                
                    <a href="../../book/vol2/day3.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Day 3 - rayon
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="book/vol2/day4.html">
            
                
                    <a href="../../book/vol2/day4.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Day 4 - structured logging
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="book/vol2/day5.html">
            
                
                    <a href="../../book/vol2/day5.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        Day 5 - environment variables
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="book/vol2/day6.html">
            
                
                    <a href="../../book/vol2/day6.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                        Day 6 - derive_builder
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="book/vol2/day7.html">
            
                
                    <a href="../../book/vol2/day7.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.7.</b>
                        
                        Day 7 - static initialization
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="book/vol2/day8.html">
            
                
                    <a href="../../book/vol2/day8.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.8.</b>
                        
                        Day 8 - serde
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="book/vol2/day9.html">
            
                
                    <a href="../../book/vol2/day9.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.9.</b>
                        
                        Day 9 - winreg
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="book/vol2/day10.html">
            
                
                    <a href="../../book/vol2/day10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.10.</b>
                        
                        Day 10 - nom, part 1
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.11" data-path="book/vol2/day11.html">
            
                
                    <a href="../../book/vol2/day11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.11.</b>
                        
                        Day 11 - nom, part 2
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.12" data-path="book/vol2/day12.html">
            
                
                    <a href="../../book/vol2/day12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.12.</b>
                        
                        Day 12 - clap
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.13" data-path="book/vol2/day13.html">
            
                
                    <a href="../../book/vol2/day13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.13.</b>
                        
                        Day 13 - zip and lzma compression
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.14" data-path="book/vol2/day14.html">
            
                
                    <a href="../../book/vol2/day14.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.14.</b>
                        
                        Day 14 - Cursive
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.15" data-path="book/vol2/day15.html">
            
                
                    <a href="../../book/vol2/day15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.15.</b>
                        
                        Day 15 - tera
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.16" data-path="book/vol2/day16.html">
            
                
                    <a href="../../book/vol2/day16.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.16.</b>
                        
                        Day 16 - git2
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.17" data-path="book/vol2/day17.html">
            
                
                    <a href="../../book/vol2/day17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.17.</b>
                        
                        Day 17 - diesel
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.18" data-path="book/vol2/day18.html">
            
                
                    <a href="../../book/vol2/day18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.18.</b>
                        
                        Day 18 - error_chain
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.19" data-path="book/vol2/day19.html">
            
                
                    <a href="../../book/vol2/day19.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.19.</b>
                        
                        Day 19 - leftpad
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >24 days of Rust</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="day-2--hound">Day 2 - hound</h1>
<p>My engineering diploma involved some digital signal processing (DSP),
in particular sound generation and recognition. Throughout my studies
I went through a ton of audio files, usually using C++ to process them.
I&apos;ve written a custom <code>.wav</code> file loader, of course missed a few edge
cases and it crashed upon receiving new training data from my supervisor...</p>
<p>A few months later I discovered that Python
<a href="https://docs.python.org/3.5/library/wave.html" target="_blank">suports WAV</a> in the standard
library. Since then I try not to reinvent the wheel when it comes to processing
<code>.wav</code> files. Luckily there&apos;s a great library for doing that in Rust -
<a href="https://crates.io/crates/hound" target="_blank">hound</a>.</p>
<h2 id="writing-to-wav-file">Writing to .wav file</h2>
<p>The canonical <em>Hello World</em> program in the land of digital signal processing is
one that generates a sine wave.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> hound;

<span class="hljs-keyword">use</span> std::f32::consts::PI;
<span class="hljs-keyword">use</span> hound::{SampleFormat, WavSpec, WavWriter};

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">generate_sine</span></span>(filename: &amp;<span class="hljs-keyword">str</span>, frequency: <span class="hljs-keyword">f32</span>, duration: <span class="hljs-keyword">u32</span>) {
    <span class="hljs-keyword">let</span> header = WavSpec {
        channels: <span class="hljs-number">1</span>,
        sample_rate: <span class="hljs-number">44100</span>,
        bits_per_sample: <span class="hljs-number">16</span>,
        sample_format: SampleFormat::Int,
    };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> writer = WavWriter::create(filename, header).expect(<span class="hljs-string">&quot;Failed to created WAV writer&quot;</span>);
    <span class="hljs-keyword">let</span> num_samples = duration * header.sample_rate;
    <span class="hljs-keyword">let</span> signal_amplitude = <span class="hljs-number">16384f32</span>;
    <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..num_samples {
        <span class="hljs-keyword">let</span> t: <span class="hljs-keyword">f32</span> = n <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span> / header.sample_rate <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span>;
        <span class="hljs-keyword">let</span> x = signal_amplitude * (t * frequency * <span class="hljs-number">2.0</span> * PI).sin();
        writer.write_sample(x <span class="hljs-keyword">as</span> <span class="hljs-keyword">i16</span>).unwrap();
    }
}

generate_sine(<span class="hljs-string">&quot;test.wav&quot;</span>, <span class="hljs-number">1000f32</span>, <span class="hljs-number">5</span>);
</code></pre>
<p>Our <code>generate_sine</code> function takes three arguments - path to output file,
desired frequency of the sine wave and a total duration (in seconds). We start
by creating a <code>WavSpec</code> struct, which is essentially a higher-level view of the
WAV header. Then we open the file to write samples according to the spec. We
need to cast calculated sample to type consistent with <code>sample_format</code> field
of the spec, otherwise <code>write_sample()</code> panics at runtime.</p>
<p>If we run that code and open the generated file with an audio player, we should
hear a 5 second beep at 1 kHz.</p>
<h2 id="calculating-signal-energy">Calculating signal energy</h2>
<p>Signal energy in DSP is understood as a sum of squared norms of all the
(discrete) signal&apos;s samples. To quote the SP4COMM book:</p>
<blockquote>
<p>This definition is consistent with the idea that, if the values of the
sequence represent a time-varying voltage, the above sum would express
the total energy (in joules) dissipated over a 1&#x3A9;-resistor.</p>
</blockquote>
<p>Since signals can come from different sources, let&apos;s abstract the concept as a
Rust trait:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">trait</span> <span class="hljs-title">Signal</span> {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">energy</span></span>(<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-keyword">f64</span>;
}
</code></pre>
<p>We can imagine implementing this trait for any signal source: microphone,
sonar, synthesizer or a WAV file. Let&apos;s implement it for <code>WavSamples</code>,
which is the actual iterator returning sample values.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">impl</span>&lt;<span class="hljs-string">&apos;a</span>, R&gt; Signal <span class="hljs-keyword">for</span> WavSamples&lt;<span class="hljs-string">&apos;a</span>, R, <span class="hljs-keyword">i16</span>&gt;
    <span class="hljs-keyword">where</span> R: std::io::Read
{
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">energy</span></span>(<span class="hljs-keyword">self</span>) -&gt; <span class="hljs-keyword">f64</span> {
        <span class="hljs-keyword">self</span>.map(|x| {
                <span class="hljs-keyword">let</span> sample = x.unwrap() <span class="hljs-keyword">as</span> <span class="hljs-keyword">f64</span>;
                sample * sample
            })
            .sum()
    }
}
</code></pre>
<p>The <code>WavSamples</code> type is parametrized by a lifetime, a type implementing
<a href="https://doc.rust-lang.org/stable/std/io/trait.Read.html" target="_blank"><code>Read</code></a> and a sample
type. For this example I decided fixing sample type to <code>i16</code> to avoid non-scalar
casts with generic types. The actual calculation is very simple - for every
sample, calculate it&apos;s square and sum it all up.</p>
<h2 id="finding-spectral-peaks">Finding spectral peaks</h2>
<p>A common task in DSP is to find the most dominant frequency in the signal. To
do that, we need to calculate the frequency spectrum of our signal and then
find peaks in the spectrum. Moving from time domain to frequency domain
involves a calculation known as
<a href="https://en.wikipedia.org/wiki/Fourier_transform" target="_blank">Fourier transform</a>. FFT is
a family of fast algorithms to compute Fourier transforms and there is a ton of
packages for FFT in many programming languages. I chose
<a href="https://crates.io/crates/rustfft" target="_blank">rustfft</a> since it&apos;s written purely in Rust.
(Other crates may be faster, but they&apos;re usually bindings to C or C++
libraries.)</p>
<pre><code class="lang-rust"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> num;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rustfft;

<span class="hljs-keyword">use</span> num::complex::Complex;
<span class="hljs-keyword">use</span> rustfft::FFT;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">find_spectral_peak</span></span>(filename: &amp;<span class="hljs-keyword">str</span>) -&gt; <span class="hljs-built_in">Option</span>&lt;<span class="hljs-keyword">f32</span>&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> reader = WavReader::open(filename).expect(<span class="hljs-string">&quot;Failed to open WAV file&quot;</span>);
    <span class="hljs-keyword">let</span> num_samples = reader.len() <span class="hljs-keyword">as</span> usize;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> fft = FFT::new(num_samples, <span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">let</span> signal = reader.samples::&lt;<span class="hljs-keyword">i16</span>&gt;()
        .map(|x| Complex::new(x.unwrap() <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span>, <span class="hljs-number">0f32</span>))
        .collect::&lt;<span class="hljs-built_in">Vec</span>&lt;_&gt;&gt;();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> spectrum = signal.clone();
    fft.process(&amp;signal[..], &amp;<span class="hljs-keyword">mut</span> spectrum[..]);
    <span class="hljs-keyword">let</span> max_peak = spectrum.iter()
        .take(num_samples / <span class="hljs-number">2</span>)
        .enumerate()
        .max_by_key(|&amp;(_, freq)| freq.norm() <span class="hljs-keyword">as</span> <span class="hljs-keyword">u32</span>);
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-built_in">Some</span>((i, _)) = max_peak {
        <span class="hljs-keyword">let</span> bin = <span class="hljs-number">44100f32</span> / num_samples <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span>;
        <span class="hljs-built_in">Some</span>(i <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span> * bin)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">None</span>
    }
}
</code></pre>
<p>This function takes a filename as an argument and (possibly) returns the
strongest frequency in the signal. As the function is slightly complex (pun
totally intended), let&apos;s go through some of the important parts.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> num_samples = reader.len() <span class="hljs-keyword">as</span> usize;
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> fft = FFT::new(num_samples, <span class="hljs-keyword">false</span>);
<span class="hljs-keyword">let</span> signal = reader.samples::&lt;<span class="hljs-keyword">i16</span>&gt;()
    .map(|x| Complex::new(x.unwrap() <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span>, <span class="hljs-number">0f32</span>))
    .collect::&lt;<span class="hljs-built_in">Vec</span>&lt;_&gt;&gt;();
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> spectrum = signal.clone();
fft.process(&amp;signal[..], &amp;<span class="hljs-keyword">mut</span> spectrum[..]);
</code></pre>
<p>We need to know up front the length of the transform. Next we collect our
data from WAV file into a complex vector (the FFT in <code>rustfft</code> can process
only complex signals). The output of the FFT is also a complex vector of
the same length, so it&apos;s easiest to clone it and declare as mutable.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">let</span> max_peak = spectrum.iter()
    .take(num_samples / <span class="hljs-number">2</span>)
    .enumerate()
    .max_by_key(|&amp;(_, freq)| freq.norm() <span class="hljs-keyword">as</span> <span class="hljs-keyword">u32</span>);
</code></pre>
<p>The FFT spectrum is symmetrical, so we&apos;re interested only in the first half of
it. Using <code>enumerate()</code>, we pair up each value in the spectrum with its index.
Later in the call to <code>max_by_key()</code> we ignore the index, but use the norm
of current value for comparison.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-built_in">Some</span>((i, _)) = max_peak {
    <span class="hljs-keyword">let</span> bin = <span class="hljs-number">44100f32</span> / num_samples <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span>;
    <span class="hljs-built_in">Some</span>(i <span class="hljs-keyword">as</span> <span class="hljs-keyword">f32</span> * bin)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">None</span>
}
</code></pre>
<p>Finally we pattern match using <code>if let</code> to extract just the index of the
maximum value. <code>bin</code> is the width of a single frequency bin in spectrum,
so if we multiply the index with bin width, we get the frequency at that index.</p>
<pre><code class="lang-rust"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-built_in">Some</span>(peak) = find_spectral_peak(<span class="hljs-string">&quot;test.wav&quot;</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Max frequency: {} Hz&quot;</span>, peak);
}
</code></pre>
<p>If we run this function on the WAV file generated earlier (remember the beep?),
we can confirm that was really a 1 kHz sine wave.</p>
<pre><code class="lang-text">$ cargo run
Max frequency: 1000 Hz
</code></pre>
<h2 id="further-reading">Further reading</h2>
<ul>
<li><a href="https://www.coursera.org/learn/dsp" target="_blank">A Coursera course on DSP</a></li>
<li><a href="http://www.sp4comm.org/" target="_blank">SP4COMM - Signal Processing for Communications</a></li>
</ul>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../book/vol2/day1.html" class="navigation navigation-prev " aria-label="Previous page: Day 1 - cargo subcommands"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../book/vol2/day3.html" class="navigation navigation-next " aria-label="Next page: Day 3 - rayon"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"include-codeblock":{},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
